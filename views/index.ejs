<% include header.html %>

<script src="/socket.io/socket.io.js"></script>

<script>
    var sensors = <%- JSON.stringify(sensors) %>;

$(function() {
 if(window.WebSocket){
var socket = io.connect();
/*
var socket = io.connect('http://localhost:9999', {
  'reconnect': true,
  'reconnection delay': 1000,
  'max reconnection attempts': 1000
});
*/

    socket.on('sensor.load', function(data) {
	sensors = data;
	displayData();
    });

    socket.on('sensor.update', function (data) {
	var found = false;

        $.each(sensors, function(index) {
		if (data.id == sensors[index].id)
		{
			sensors[index].value = data.value;
			found = true;
		}
        });
	if (!found) sensors.push(data);
	displayData();
    });
 } else {
  setInterval("updateData()", 5000);
 }
});


function updateData()
{
	$.get('/sensors', function(data) {
		sensors = data;
		displayData();
	});
}

function displayData()
{
 	var html= "<table class='table'><thead><tr><th>Name</th><th>Value</th><th>Last update</th></tr></thead>";
        $.each(sensors, function(index) {
	    var d = moment(sensors[index].time).format('DD/MM-YYYY HH:mm');
            html += "<tr><td>"+sensors[index].id + "</td><td>" + numeral(sensors[index].value).format('0.00') + "</td><td>"+d+"</td></tr>";
        });
        html +=	"</table>";
	$("#data").html(html);
}
</script>

      <div class="row">
        <div class="col-lg-4">
          <h2>Sensors</h2>
          <p id="data"></p>
        </div>
      </div>

<% include footer.html %>
